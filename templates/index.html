{% extends "base.html" %}

{% block title %}Home - Duplicate File Detector{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">
                <i class="fas fa-search me-3 text-primary"></i>
                Find Duplicate Files
            </h1>
            <p class="lead text-muted">
                Scan any directory to identify duplicate files and reclaim valuable disk space.
            </p>
        </div>

        <!-- Directory Selection Form -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-folder-open me-2"></i>
                    Select Directory to Scan
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.scan_directory') }}" id="scanForm">
                    <div class="mb-4">
                        <label for="directory" class="form-label">Directory Path</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-folder"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="directory" 
                                   name="directory" 
                                   placeholder="Enter full path to directory (e.g., C:\Users\YourName\Documents)"
                                   required>
                            <button type="button" class="btn btn-outline-secondary" onclick="openFolderBrowser()">
                                <i class="fas fa-folder-open"></i>
                                Browse
                            </button>
                        </div>
                        <div class="form-text">
                            Enter the full path to the directory you want to scan for duplicate files.
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle text-info me-2"></i>
                                    Scan Information
                                </h6>
                                <ul class="list-unstyled mb-0">
                                    <li><i class="fas fa-check text-success me-2"></i>Scans all subdirectories recursively</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Uses SHA-256 hashing for accurate detection</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Identifies files by content, not just name</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Safe read-only operation</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="scanButton">
                            <i class="fas fa-search me-2"></i>
                            Start Scan
                        </button>
                    </div>
                </form>

                <!-- Progress Bar (hidden by default) -->
                <div class="progress-container mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Scanning files...</span>
                        <span class="text-muted" id="progressText">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%" 
                             id="progressBar">
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">This may take a while for large directories...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Tips -->
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-lightning-bolt fa-2x text-warning mb-3"></i>
                        <h6>Fast & Efficient</h6>
                        <p class="card-text text-muted small">
                            Uses optimized algorithms to quickly scan even large directories with thousands of files.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                        <h6>Safe & Secure</h6>
                        <p class="card-text text-muted small">
                            Read-only scanning with no modifications to your files. Your data stays safe.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-bar fa-2x text-info mb-3"></i>
                        <h6>Detailed Reports</h6>
                        <p class="card-text text-muted small">
                            Get comprehensive reports showing duplicate groups, file sizes, and potential space savings.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Folder Browser Modal -->
<div class="modal fade" id="folderBrowserModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder-tree me-2"></i>
                    Browse Folders
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Breadcrumb Navigation -->
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb" id="folderBreadcrumb">
                        <li class="breadcrumb-item active">Loading...</li>
                    </ol>
                </nav>
                
                <!-- Current Path Display -->
                <div class="mb-3">
                    <label class="form-label">Selected Path:</label>
                    <input type="text" class="form-control" id="selectedPath" readonly>
                </div>
                
                <!-- Folder List -->
                <div class="border rounded" style="height: 400px; overflow-y: auto;">
                    <div id="folderList" class="list-group list-group-flush">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading folders...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Folder Info -->
                <div class="mt-3">
                    <small class="text-muted" id="folderInfo">Select a folder to see details</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="selectFolderBtn" onclick="selectCurrentFolder()" disabled>
                    <i class="fas fa-check me-2"></i>
                    Select This Folder
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentBrowsePath = '';
let folderBrowserModal = null;

function openFolderBrowser() {
    if (!folderBrowserModal) {
        folderBrowserModal = new bootstrap.Modal(document.getElementById('folderBrowserModal'));
    }
    
    // Reset the browser state
    currentBrowsePath = '';
    document.getElementById('selectedPath').value = '';
    document.getElementById('selectFolderBtn').disabled = true;
    
    // Show modal and load root folders
    folderBrowserModal.show();
    loadFolders('');
}

function loadFolders(path) {
    const folderList = document.getElementById('folderList');
    const breadcrumb = document.getElementById('folderBreadcrumb');
    const folderInfo = document.getElementById('folderInfo');
    
    // Show loading state
    folderList.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading folders...</div>
        </div>
    `;
    
    // Fetch folder contents
    const url = `/api/browse-folders${path ? '?path=' + encodeURIComponent(path) : ''}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentBrowsePath = data.current_path;
                updateBreadcrumb(data.current_path);
                displayFolders(data.items);
                updateSelectedPath(data.current_path);
                folderInfo.textContent = `${data.items.length} items found`;
            } else {
                folderList.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.error || 'Failed to load folders'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading folders:', error);
            folderList.innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading folders. Please try again.
                </div>
            `;
        });
}

function displayFolders(items) {
    const folderList = document.getElementById('folderList');
    
    if (items.length === 0) {
        folderList.innerHTML = `
            <div class="text-center p-4 text-muted">
                <i class="fas fa-folder-open fa-3x mb-3"></i>
                <div>No accessible folders found</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    items.forEach(item => {
        const iconClass = item.type === 'drive' ? 'fas fa-hard-drive' : 
                         item.type === 'parent' ? 'fas fa-level-up-alt' : 
                         'fas fa-folder';
        
        const accessibleClass = item.accessible ? '' : 'text-muted';
        const clickable = item.accessible ? `onclick="navigateToFolder('${item.path.replace(/\\/g, '\\\\')}')"` : '';
        const cursor = item.accessible ? 'cursor: pointer;' : 'cursor: not-allowed;';
        
        html += `
            <div class="list-group-item list-group-item-action ${accessibleClass}" 
                 ${clickable}
                 style="${cursor}"
                 title="${item.accessible ? 'Click to open' : 'Access denied'}">
                <div class="d-flex align-items-center">
                    <i class="${iconClass} me-3"></i>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${item.name}</div>
                        <small class="text-muted">${item.path}</small>
                    </div>
                    ${!item.accessible ? '<i class="fas fa-lock text-warning"></i>' : ''}
                </div>
            </div>
        `;
    });
    
    folderList.innerHTML = html;
}

function navigateToFolder(path) {
    loadFolders(path);
}

function updateBreadcrumb(path) {
    const breadcrumb = document.getElementById('folderBreadcrumb');
    
    if (!path) {
        breadcrumb.innerHTML = '<li class="breadcrumb-item active">Root</li>';
        return;
    }
    
    const pathParts = path.split(/[\\\/]/).filter(part => part);
    let html = '<li class="breadcrumb-item"><a href="#" onclick="loadFolders(\'\')">Root</a></li>';
    
    let buildPath = '';
    pathParts.forEach((part, index) => {
        if (index === 0 && part.includes(':')) {
            // Windows drive
            buildPath = part + '\\';
        } else {
            buildPath += (buildPath.endsWith('\\') || buildPath.endsWith('/') ? '' : '/') + part;
        }
        
        if (index === pathParts.length - 1) {
            html += `<li class="breadcrumb-item active">${part}</li>`;
        } else {
            html += `<li class="breadcrumb-item"><a href="#" onclick="loadFolders('${buildPath.replace(/\\/g, '\\\\')}')">${part}</a></li>`;
        }
    });
    
    breadcrumb.innerHTML = html;
}

function updateSelectedPath(path) {
    document.getElementById('selectedPath').value = path || '';
    document.getElementById('selectFolderBtn').disabled = !path;
}

function selectCurrentFolder() {
    if (currentBrowsePath) {
        document.getElementById('directory').value = currentBrowsePath;
        folderBrowserModal.hide();
        
        // Validate the selected path
        validateSelectedPath(currentBrowsePath);
    }
}

function validateSelectedPath(path) {
    fetch('/api/validate-path', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ path: path })
    })
    .then(response => response.json())
    .then(data => {
        const directoryInput = document.getElementById('directory');
        
        if (data.valid) {
            directoryInput.classList.remove('is-invalid');
            directoryInput.classList.add('is-valid');
            
            // Show folder info
            const infoText = `Valid directory: ${data.file_count} files, ${data.dir_count} subdirectories`;
            showValidationMessage(infoText, 'success');
        } else {
            directoryInput.classList.remove('is-valid');
            directoryInput.classList.add('is-invalid');
            showValidationMessage(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Validation error:', error);
        showValidationMessage('Could not validate path', 'error');
    });
}

function showValidationMessage(message, type) {
    // Remove existing message
    const existingMsg = document.querySelector('.validation-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // Add new message
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const directoryInput = document.getElementById('directory');
    const messageHtml = `
        <div class="alert ${alertClass} mt-2 validation-message">
            <small>${message}</small>
        </div>
    `;
    directoryInput.parentNode.insertAdjacentHTML('afterend', messageHtml);
}

document.getElementById('scanForm').addEventListener('submit', function(e) {
    const button = document.getElementById('scanButton');
    const progressContainer = document.querySelector('.progress-container');
    
    // Show progress and disable button
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Scanning...';
    progressContainer.style.display = 'block';
    
    // Simulate progress (since we can't get real progress from server)
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 95) progress = 95;
        
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
        
        if (progress >= 95) {
            clearInterval(interval);
        }
    }, 500);
});

// Auto-populate with common directory paths based on OS
window.addEventListener('load', function() {
    const directoryInput = document.getElementById('directory');
    const userAgent = navigator.userAgent;
    
    if (userAgent.includes('Windows')) {
        directoryInput.placeholder = 'e.g., C:\\Users\\' + (navigator.userAgent.includes('Win') ? 'YourName' : 'username') + '\\Documents';
    } else if (userAgent.includes('Mac')) {
        directoryInput.placeholder = 'e.g., /Users/username/Documents';
    } else {
        directoryInput.placeholder = 'e.g., /home/username/Documents';
    }
});
</script>
{% endblock %}